<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Structural Trivia Game</title>
  <style>
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      background-color: #f7faff;
      color: #002b45;
    }
    .hidden {
      display: none;
    }
    .filter-btn {
      margin: 0.3rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 12px;
      background-color: #e6f0ff;
      cursor: pointer;
    }
    .filter-btn.active {
      background-color: #007acc;
      color: white;
    }
    .tab-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      border-radius: 10px 10px 0 0;
      margin-right: 0.5rem;
    }
    .tab-btn.active {
      background: #007acc;
      color: white;
    }
    .tab-content {
      display: none;
      border: 1px solid #ccc;
      border-top: none;
      padding: 1rem;
      background: white;
      border-radius: 0 0 10px 10px;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>

  <div id="tabButtons">
    <button class="tab-btn active" onclick="switchTab('main')">Main Categories</button>
    <button class="tab-btn" onclick="switchTab('codebook')">Questions Per Codebook</button>
  </div>

  <div id="main" class="tab-content active">
    <div id="mainCategories"></div>
    <div style="margin-top: 1rem;">
      <label for="difficultyFilter">Filter by Difficulty:</label>
      <select id="difficultyFilter" onchange="filterByDifficulty()">
        <option value="all">All</option>
        <option value="Easy">Easy</option>
        <option value="Medium">Medium</option>
        <option value="Hard">Hard</option>
      </select>
      <label style="margin-left: 1rem;"><input type="checkbox" id="shuffleToggle" onchange="toggleShuffle()"> Shuffle</label>
      <label style="margin-left: 1rem;">Questions:
        <select id="questionCount" onchange="updateCount()">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
        </select>
      </label>
    </div>
    <button onclick="startQuiz()">Start Quiz</button>
  </div>

  <div id="codebook" class="tab-content">
    <div id="codebookCategories"></div>
    <button onclick="startQuiz()">Start Quiz</button>
  </div>

  <div id="questionContainer" class="hidden"></div>
  <div id="summary"></div>

  <script>
    const QUESTIONS_URL = 'https://script.google.com/macros/s/AKfycbwOqCs6AyZtKbbxk9AAt3txu1lTT9_5uLHO5lmK0ik_jy28lpq2Mo9CaElVZPy6fi6c/exec';
    let allQuestions = [];
    let selectedQuestions = [];
    let currentCategory = 'main';
    let currentIndex = 0;
    let correctCount = 0;
    let selectedDifficulty = 'all';
    let shuffleQuestions = false;
    let questionLimit = 10;
    let selectedCategory = null;

    async function fetchQuestions() {
      try {
        const res = await fetch(QUESTIONS_URL);
        const data = await res.json();
        allQuestions = data.filter(q => q.approved?.toString().toLowerCase().trim() === 'yes');
        renderCategories();
      } catch (e) {
        console.error(e);
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
      currentCategory = tab;
    }

    function renderCategories() {
      const main = document.getElementById('mainCategories');
      const code = document.getElementById('codebookCategories');
      const mainSet = new Set();
      const codeSet = new Set();
      allQuestions.forEach(q => {
        const mainCat = q.MainCategory?.toString().trim() || 'Other';
        const codebook = q.codebook?.toString().trim() || q.Codebook?.toString().trim() || 'Other';
        if (mainCat) mainSet.add(mainCat);
        if (codebook) codeSet.add(codebook);
      });
      main.innerHTML = [...mainSet].sort().map(cat => `<button class="filter-btn" onclick="selectCategory('${cat.replace(/'/g, '\\'')}')">${cat}</button>`).join('');
      code.innerHTML = [...codeSet].sort().map(cb => `<button class="filter-btn" onclick="selectCategory('${cb.replace(/'/g, '\\'')}')">${cb}</button>`).join('');
    }

    function selectCategory(cat) {
      selectedCategory = cat;
    }

    function toggleShuffle() {
      shuffleQuestions = document.getElementById('shuffleToggle').checked;
    }

    function filterByDifficulty() {
      selectedDifficulty = document.getElementById('difficultyFilter').value;
    }

    function updateCount() {
      questionLimit = parseInt(document.getElementById('questionCount').value);
    }

    function startQuiz() {
      if (!selectedCategory) return alert("Select a category first");
      const filtered = allQuestions.filter(q => {
        const match = currentCategory === 'main'
          ? q.MainCategory?.toString().trim() === selectedCategory
          : (q.codebook?.toString().trim() || q.Codebook?.toString().trim()) === selectedCategory;
        const level = q.difficulty || q.Difficulty || 'Unknown';
        return match && (selectedDifficulty === 'all' || level === selectedDifficulty);
      });
      selectedQuestions = shuffleQuestions ? filtered.sort(() => Math.random() - 0.5) : filtered;
      selectedQuestions = selectedQuestions.slice(0, questionLimit);
      currentIndex = 0;
      correctCount = 0;
      document.getElementById('main').classList.add('hidden');
      document.getElementById('codebook').classList.add('hidden');
      document.getElementById('questionContainer').classList.remove('hidden');
      showQuestion();
    }

    function showQuestion() {
      const container = document.getElementById('questionContainer');
      if (currentIndex >= selectedQuestions.length) return showSummary();
      const q = selectedQuestions[currentIndex];
      const allAnswers = [q.correct, q.incorrect1, q.incorrect2, q.incorrect3].sort(() => Math.random() - 0.5);
      container.innerHTML = `
        <p><strong>Q${currentIndex + 1}:</strong> ${q.question}</p>
        ${allAnswers.map(a => `<button onclick="checkAnswer('${a.replace(/'/g, '\\'')}', '${q.correct.replace(/'/g, '\\')}')">${a}</button>`).join('<br>')}
      `;
    }

    function checkAnswer(choice, correct) {
      if (choice === correct) correctCount++;
      currentIndex++;
      showQuestion();
    }

    function showSummary() {
      document.getElementById('questionContainer').innerHTML = `<h2>Quiz Complete</h2><p>You got ${correctCount} of ${selectedQuestions.length} correct!</p>`;
    }

    window.onload = fetchQuestions;
  </script>
</body>
</html>
