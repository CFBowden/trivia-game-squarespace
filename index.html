<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Structural Engineering Trivia</title>

<style>
  html {
    box-sizing: border-box;
    font-size: 16px;
  }
  *, *:before, *:after {
    box-sizing: inherit;
  }
  body {
    font-family: 'Segoe UI', Roboto, sans-serif;
    background: radial-gradient(circle at top, #f0f4f8, #dbe9f4);
    color: #002b45;
    margin: 0;
    padding: 1.5rem;
    max-width: 100%;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  h1 {
    text-align: center;
    font-size: 2rem;
    color: #003366;
    margin-bottom: 1.2rem;
  }
  .filters {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  @media (min-width: 600px) {
    .filters {
      flex-direction: row;
    }
  }
  select {
    padding: 0.6rem;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #bbb;
    background-color: #fefefe;
    color: #002b45;
    width: 100%;
  }
  .question-box {
    background: white;
    border: 2px solid #007acc;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
    transition: transform 0.2s ease;
  }
  .question-box:hover {
    transform: scale(1.01);
  }
  .code-ref {
    margin-top: 1rem;
    font-size: 0.9rem;
    color: #666;
  }
  button.answer {
    display: block;
    width: 100%;
    padding: 0.85rem;
    margin: 0.5rem 0;
    background-color: #007acc;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button.answer:hover {
    background-color: #005fa3;
  }
  #score {
    font-weight: bold;
    text-align: center;
    margin-bottom: 2rem;
    font-size: 1.1rem;
    color: #003366;
  }
</style>
</head>
<body>
  <h1>Structural Engineering Trivia</h1>

  <div class="filters">
    <select id="difficultyFilter" aria-label="Filter by Difficulty">
      <option value="">All Difficulty</option>
      <option value="easy">Easy</option>
      <option value="medium">Medium</option>
      <option value="challenging">Challenging</option>
    </select>

    <select id="codebookFilter" aria-label="Filter by Code Book">
      <option value="">All Code Books</option>
      <option value="aci 318">ACI 318</option>
      <option value="asce 7">ASCE 7</option>
      <option value="tms 402">TMS 402</option>
      <option value="aisc">AISC</option>
      <option value="nds">NDS</option>
      <option value="other">Other</option>
    </select>
  </div>

  <div id="score">Score: 0 / 0</div>
  <div id="questionContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQlxPNJARM2ZnIKMPvCue9POaEWokF9IeTHeP7eMIbck-oB5xBN9LdbrLD8uREvExBDe7ggPNipa63w/pub?output=csv";

    let allQuestions = [];
    let filteredQuestions = [];
    let currentIndex = 0;
    let score = 0;
    let total = 0;

    function updateScoreDisplay() {
      document.getElementById("score").innerText = `Score: ${score} / ${total}`;
    }

    function loadCSV() {
      fetch(CSV_URL)
        .then(response => {
          if (!response.ok) throw new Error("Network response was not ok");
          return response.text();
        })
        .then(text => {
          console.log("CSV Raw Text:", text);

          const data = Papa.parse(text, { header: false }).data;
          console.log("Parsed Data:", data);

          allQuestions = data.slice(1).map(c => ({
            question: c[0] || "",
            correct: c[1] || "",
            codeRef: c[2] || "",
            incorrect: [c[3], c[4], c[5]].filter(x => x && x.trim() !== ""),
            approved: (c[6] || "").trim().toLowerCase() === "yes",
            difficulty: (c[7] || "").trim().toLowerCase(),
            codebook: (c[8] || "").trim().toLowerCase()
          }));

          console.log("Final Questions:", allQuestions);

          applyFilters();
        })
        .catch(error => {
          console.error("Error loading CSV:", error);
          document.getElementById("questionContainer").innerHTML = "<p style='color:red;'>Failed to load questions.</p>";
        });
    }

    function applyFilters() {
      const difficulty = document.getElementById("difficultyFilter").value.trim().toLowerCase();
      const codebook = document.getElementById("codebookFilter").value.trim().toLowerCase();

      filteredQuestions = allQuestions.filter(q => {
        const matchDifficulty = !difficulty || q.difficulty === difficulty;
        const matchCodebook = !codebook || q.codebook === codebook;
        return q.approved && matchDifficulty && matchCodebook;
      });

      currentIndex = 0;
      score = 0;
      total = filteredQuestions.length;
      updateScoreDisplay();
      loadQuestion();
    }

    function loadQuestion() {
      const container = document.getElementById("questionContainer");
      if (filteredQuestions.length === 0) {
        container.innerHTML = "<p>No questions match the filter.</p>";
        return;
      }

      const q = filteredQuestions[currentIndex];
      let answers = [...q.incorrect, q.correct];
      answers = answers.sort(() => Math.random() - 0.5);

      container.innerHTML = `
        <div class="question-box">
          <p>${q.question}</p>
          <div class="code-ref">
            <div><strong>Code Book:</strong> ${q.codebook.toUpperCase()}</div>
            <div><strong>Reference:</strong> ${q.codeRef}</div>
          </div>
          <div id="answers"></div>
        </div>
      `;

      const answersDiv = container.querySelector("#answers");

      answers.forEach(ans => {
        const btn = document.createElement("button");
        btn.className = "answer";
        btn.textContent = ans;
        btn.onclick = () => {
          if (ans === q.correct) {
            score++;
            alert("Correct!");
          } else {
            alert(`Wrong! Correct answer: ${q.correct}`);
          }
          currentIndex++;
          if (currentIndex >= filteredQuestions.length) {
            alert(`Quiz complete! Your score: ${score} / ${total}`);
            currentIndex = 0;
            score = 0;
          }
          updateScoreDisplay();
          loadQuestion();
        };
        answersDiv.appendChild(btn);
      });
    }

    window.onload = () => {
      document.getElementById("difficultyFilter").addEventListener("change", applyFilters);
      document.getElementById("codebookFilter").addEventListener("change", applyFilters);
      loadCSV();
    };
  </script>
</body>
</html>
