<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Structural Trivia Game</title>
  <style>
    body {
      font-family: 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      background-color: #f7faff;
      color: #002b45;
    }
    .hidden {
      display: none;
    }
    .filter-btn {
      margin: 0.3rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 12px;
      background-color: #e6f0ff;
      cursor: pointer;
    }
    .filter-btn.active {
      background-color: #007acc;
      color: white;
    }
    .tab-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      border-radius: 10px 10px 0 0;
      margin-right: 0.5rem;
    }
    .tab-btn.active {
      background: #007acc;
      color: white;
    }
    .tab-content {
      display: none;
      border: 1px solid #ccc;
      border-top: none;
      padding: 1rem;
      background: white;
      border-radius: 0 0 10px 10px;
    }
    .tab-content.active {
      display: block;
    }
    .answer-btn {
      display: block;
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.6rem 1rem;
      font-size: 1rem;
      border: 2px solid #007acc;
      border-radius: 12px;
      background-color: #fff;
      cursor: pointer;
      text-align: left;
      transition: background-color 0.3s, color 0.3s;
    }
    .answer-btn:hover {
      background-color: #007acc;
      color: white;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center; font-size: 2rem; margin-bottom: 1rem;">Structural Trivia</h1>
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Steel-frame_building_under_construction.jpg/640px-Steel-frame_building_under_construction.jpg" style="width:100%; border-radius: 12px; margin-bottom: 2rem;" alt="Trivia banner image"/>

  <div id="tabButtons">
    <button class="tab-btn active" onclick="switchTab('main')">Main Categories</button>
    <button class="tab-btn" onclick="switchTab('codebook')">Questions Per Codebook</button>
  </div>

  <div id="main" class="tab-content active">
    <div id="mainCategories"></div>
    <div style="margin-top: 1rem;">
      <label for="difficultyFilterMain">Filter by Difficulty:</label>
      <select id="difficultyFilterMain" onchange="filterByDifficulty('main')">
        <option value="all">All</option>
        <option value="Easy">Easy</option>
        <option value="Medium">Medium</option>
        <option value="Hard">Hard</option>
        <option value="Impossible">Impossible</option>
      </select>
      <label style="margin-left: 1rem;">Questions:
        <select id="questionCountMain" onchange="updateCount('main')">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
        </select>
      </label>
    </div>
    <button onclick="startQuiz()">Start Quiz</button>
  </div>

  <div id="codebook" class="tab-content">
    <div id="codebookCategories"></div>
    <div style="margin-top: 1rem;">
      <label for="difficultyFilterCodebook">Filter by Difficulty:</label>
      <select id="difficultyFilterCodebook" onchange="filterByDifficulty('codebook')">
        <option value="all">All</option>
        <option value="Easy">Easy</option>
        <option value="Medium">Medium</option>
        <option value="Hard">Hard</option> 
        <option value="Impossible">Impossible</option>
      </select>
      <label style="margin-left: 1rem;">Questions:
        <select id="questionCountCodebook" onchange="updateCount('codebook')">
          <option value="5">5</option>
          <option value="10" selected>10</option>
          <option value="20">20</option>
        </select>
      </label>
    </div>
    <button onclick="startQuiz()">Start Quiz</button>
  </div>

  <div id="questionContainer" class="hidden"></div>
  <div id="summary"></div>

  <script>
    const QUESTIONS_URL = 'https://script.google.com/macros/s/AKfycbwOqCs6AyZtKbbxk9AAt3txu1lTT9_5uLHO5lmK0ik_jy28lpq2Mo9CaElVZPy6fi6c/exec';
    let allQuestions = [];
    let selectedQuestions = [];
    let currentCategory = 'main';
    let currentIndex = 0;
    let correctCount = 0;
    let selectedDifficulty = { main: 'all', codebook: 'all' };
    let questionLimit = { main: 10, codebook: 10 };
    let selectedCategory = null;

    async function fetchQuestions() {
      try {
        const res = await fetch(QUESTIONS_URL);
        const data = await res.json();
        allQuestions = data.filter(q => q.approved?.toString().toLowerCase().trim() === 'yes');
        renderCategories();
      } catch (e) {
        console.error('Error fetching questions:', e);
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
      currentCategory = tab;
      selectedCategory = null;
    }

    function renderCategories() {
      const mainDiv = document.getElementById('mainCategories');
      const codeDiv = document.getElementById('codebookCategories');
      const mainSet = new Set();
      const codeSet = new Set();
      allQuestions.forEach(q => {
        const mainCat = q.MainCategory?.toString().trim() || 'Other';
        const codebook = q.codebook?.toString().trim() || q.Codebook?.toString().trim() || 'Other';
        mainSet.add(mainCat);
        codeSet.add(codebook);
      });
      mainDiv.innerHTML = [...mainSet].sort().map(cat => `<button class="filter-btn" onclick="selectCategory('${cat.replace(/'/g, "\'")}', 'main', this)">${cat}</button>`).join('');
      codeDiv.innerHTML = [...codeSet].sort().map(cb => `<button class="filter-btn" onclick="selectCategory('${cb.replace(/'/g, "\'")}', 'codebook', this)">${cb}</button>`).join('');
    }

    function selectCategory(cat, tab, btn) {
      document.querySelectorAll(`#${tab} .filter-btn`).forEach(el => el.classList.remove('active'));
      btn.classList.add('active');
      selectedCategory = cat;
    }

    function filterByDifficulty(type) {
      selectedDifficulty[type] = document.getElementById(`difficultyFilter${capitalize(type)}`).value;
    }

    function updateCount(type) {
      questionLimit[type] = parseInt(document.getElementById(`questionCount${capitalize(type)}`).value);
    }

    function capitalize(s) {
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function startQuiz() {
      if (!selectedCategory) return alert("Select a category first");
      const filtered = allQuestions.filter(q => {
        const match = currentCategory === 'main'
          ? q.MainCategory?.toString().trim() === selectedCategory
          : (q.codebook?.toString().trim() || q.Codebook?.toString().trim()) === selectedCategory;
        const level = q.difficulty || q.Difficulty || 'Unknown';
        return match && (selectedDifficulty[currentCategory] === 'all' || level === selectedDifficulty[currentCategory]);
      });
      selectedQuestions = filtered.slice(0, questionLimit[currentCategory]);
      currentIndex = 0;
      correctCount = 0;
      document.getElementById('main').classList.add('hidden');
      document.getElementById('codebook').classList.add('hidden');
      document.getElementById('questionContainer').classList.remove('hidden');
      showQuestion();
    }

    function showQuestion() {
      const container = document.getElementById('questionContainer');
      if (currentIndex >= selectedQuestions.length) return showSummary();
      const q = selectedQuestions[currentIndex];
      const answers = [];
      if (q.correct) answers.push(q.correct);
      ['incorrect1', 'incorrect2', 'incorrect3'].forEach(key => {
        if (q[key]) answers.push(q[key]);
      });
      const shuffled = answers.filter(a => a && a.trim()).sort(() => Math.random() - 0.5);
      container.innerHTML = `
        <button onclick="goBack()" style="margin-bottom: 1rem; background: #ccc; border: none; padding: 0.5rem 1rem; border-radius: 8px;">‚Üê Back to Categories</button>
        <p><strong>Q${currentIndex + 1}:</strong> ${q.question}</p>
        ${shuffled.map(a => `<button class="answer-btn" onclick="checkAnswer('${a.replace(/'/g, "\'")}', '${q.correct.replace(/'/g, "\'")}')">${a}</button>`).join('')}
      `;
    }

    function checkAnswer(choice, correct) {
      if (choice === correct) correctCount++;
      currentIndex++;
      showQuestion();
    }

    function goBack() {
      document.getElementById('questionContainer').classList.add('hidden');
      document.getElementById(currentCategory).classList.remove('hidden');
    }

    function showSummary() {
      document.getElementById('questionContainer').innerHTML = `<h2>Quiz Complete</h2><p>You got ${correctCount} of ${selectedQuestions.length} correct!</p>`;
    }

    window.onload = fetchQuestions;
  </script>
</body>
</html>

