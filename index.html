<script>
  // Your deployed Apps Script endpoint (approved-only)
  const QUESTIONS_URL = 'https://script.google.com/macros/s/AKfycbwOqCs6AyZtKbbxk9AAt3txu1lTT9_5uLHO5lmK0ik_jy28lpq2Mo9CaElVZPy6fi6c/exec';

  // -------- State --------
  let allRows = [];
  let selectedCategory = null;
  let selectedQuestions = [];
  let currentIndex = 0;
  let correctCount = 0;
  let userResponses = [];

  // -------- Utils --------
  const norm = s => String(s ?? '').trim();
  const lc   = s => norm(s).toLowerCase();
  function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function show(el){ el.classList.remove('hidden'); }
  function hide(el){ el.classList.add('hidden'); }

  function renderCategoriesFromData(rows) {
    const cats = Array.from(new Set(rows.map(r => r.maincategory).filter(Boolean))).sort();
    const html = cats.map(cat => `<button class="filter-btn" data-cat="${cat}">${cat}</button>`).join('');
    const bar = document.getElementById('categoryBar');
    bar.innerHTML = html;
    bar.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        bar.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedCategory = btn.dataset.cat;
      });
    });
  }

  // ------- NEW: build choices for a row (2–4 options) -------
  function buildChoicesForRow(q) {
    const raw = [
      { text: norm(q.correct),   isCorrect: true  },
      { text: norm(q.incorrect1), isCorrect: false },
      { text: norm(q.incorrect2), isCorrect: false },
      { text: norm(q.incorrect3), isCorrect: false },
    ].filter(c => !!c.text);

    // de-dupe by lowercase text
    const seen = new Set();
    const unique = [];
    for (const c of raw) {
      const key = lc(c.text);
      if (seen.has(key)) continue;
      seen.add(key);
      unique.push(c);
    }
    return unique; // may be length 2, 3, or 4
  }

  function showQuestion() {
    const container = document.getElementById('questionContainer');
    if (currentIndex >= selectedQuestions.length) return showSummary();

    const q = selectedQuestions[currentIndex];
    let choices = buildChoicesForRow(q);

    // If something slipped through with < 2 choices, skip to next
    if (choices.length < 2) {
      currentIndex++;
      return showQuestion();
    }

    choices = shuffle(choices);

    container.innerHTML = `
      <button onclick="goBack()" style="margin-bottom:1rem;background:#ccc;border:none;padding:0.5rem 1rem;border-radius:8px;">← Back</button>
      <p><strong>Q${currentIndex + 1}:</strong> ${q.question}</p>
      ${choices.map(c =>
        `<button class="answer-btn" data-correct="${c.isCorrect}" onclick="checkAnswer(this)">${c.text}</button>`
      ).join('')}
      <div style="margin-top:0.5rem; font-size:0.9rem; color:#3b4b5a;"><em>${q.codebook}${q.coderef ? ' • ' + q.coderef : ''}</em></div>
    `;
  }

  function showSummary() {
    const c = document.getElementById('questionContainer');
    let html = `<h2>Quiz Complete</h2><p>You got ${correctCount} of ${selectedQuestions.length} correct!</p>`;
    html += `<table class="report-table"><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr>`;
    userResponses.forEach(r => {
      const mark = r.isCorrect ? '<span class="correct">✓</span>' : '<span class="incorrect">✗</span>';
      html += `<tr><td>${r.question}</td><td>${r.chosen}</td><td>${r.correct}</td><td>${mark}</td></tr>`;
    });
    html += `</table>`;
    c.innerHTML = html;
  }

  // ------- UPDATED: use variable-choice validation in pool -------
  function startQuiz() {
    if (!selectedCategory) return alert('Select a category first.');
    if (!allRows.length)   return alert('No approved questions loaded.');

    const diff  = lc(document.getElementById('difficultyFilter').value);
    const limit = parseInt(document.getElementById('questionCount').value, 10);

    const pool = allRows.filter(r => {
      if (r.maincategory !== selectedCategory) return false;
      if (diff !== 'all' && lc(r.difficulty) !== diff) return false;
      const choices = buildChoicesForRow(r);
      return choices.length >= 2; // must have at least 1 distractor
    });

    if (!pool.length) return alert('No approved questions match that filter.');

    selectedQuestions = shuffle(pool).slice(0, limit);
    currentIndex = 0; correctCount = 0; userResponses = [];
    hide(document.getElementById('panel'));
    const qc = document.getElementById('questionContainer'); show(qc); qc.innerHTML = '';
    showQuestion();
  }

  // ------- UPDATED: flag-based grading -------
  function checkAnswer(btnEl) {
    const isCorrect = btnEl.dataset.correct === 'true';
    const chosen    = btnEl.textContent;
    const q         = selectedQuestions[currentIndex];

    userResponses.push({
      question: q.question,
      chosen,
      correct: q.correct,   // shown for reference
      isCorrect
    });
    if (isCorrect) correctCount++;
    currentIndex++;
    showQuestion();
  }

  function goBack(){ hide(document.getElementById('questionContainer')); show(document.getElementById('panel')); selectedQuestions=[]; currentIndex=0; correctCount=0; userResponses=[]; }

  async function loadFromApi(){
    const res = await fetch(QUESTIONS_URL + '?t=' + Date.now(), { cache: 'no-store' });
    if (!res.ok) throw new Error(await res.text());
    const data = await res.json();
    if (!Array.isArray(data) || (data[0] && !('question' in data[0]))) throw new Error('Unexpected JSON shape from API.');
    allRows = data.map(r => ({
      ...r,
      difficulty: lc(r.difficulty || 'medium'),
      maincategory: r.maincategory || 'General',
      codebook: r.codebook || 'General',
      coderef: r.coderef || (r.codebook ? `${r.codebook} (General)` : 'General (General)'),
    }));
    if (!allRows.length) throw new Error('API returned 0 approved rows.');
    renderCategoriesFromData(allRows);
  }

  document.getElementById('startBtn').addEventListener('click', startQuiz);
  (async function boot(){ try { await loadFromApi(); } catch (err){ console.error('API load failed:', err); alert('Could not load questions from server.'); }})();
</script>
